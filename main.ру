import os
import telebot
import wikipedia
import sympy as sp
import re
from datetime import datetime

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
bot = telebot.TeleBot(TOKEN)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Wikipedia
wikipedia.set_lang("ru")

print("ü§ñ Sayko Bot –∑–∞–ø—É—â–µ–Ω –Ω–∞ Render!")

# –ü—Ä–æ—Å—Ç–∞—è –±–∞–∑–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
user_stats = {}

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user = message.from_user
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    user_id = user.id
    if user_id not in user_stats:
        user_stats[user_id] = {
            'name': user.first_name,
            'messages': 0,
            'last_active': datetime.now()
        }
    
    welcome_text = f"""
üéì –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

–Ø Sayko - —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é –Ω–∞ Render.com!
–°—Ç–∞–ª –±—ã—Å—Ç—Ä–µ–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ üöÄ

‚ú® –ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ üßÆ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: 2+3, x+5=10
‚Ä¢ üìö –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ üìê –†–µ—à–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–π
‚Ä¢ üìñ –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–º–µ—Ä!
"""
    bot.reply_to(message, welcome_text)
    user_stats[user_id]['messages'] += 1

# –ö–æ–º–∞–Ω–¥–∞ /help
@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = """
üìö –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Sayko:

üéØ –ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏:
‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: 2+3, 10/2, x+5=10
‚Ä¢ –£—Ä–∞–≤–Ω–µ–Ω–∏—è: —Ä–µ—à–∏—Ç—å x^2-4=0
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã: –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑?

üßÆ –ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ 2+3*5
‚Ä¢ —Ä–µ—à–∏ 2x+5=15
‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ –°–æ–ª–Ω—Ü–µ?

üöÄ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7 –Ω–∞ Render.com
"""
    bot.reply_to(message, help_text)
    
    user_id = message.from_user.id
    if user_id in user_stats:
        user_stats[user_id]['messages'] += 1

# –ö–æ–º–∞–Ω–¥–∞ /stats
@bot.message_handler(commands=['stats'])
def send_stats(message):
    total_users = len(user_stats)
    total_messages = sum(stats['messages'] for stats in user_stats.values())
    
    stats_text = f"""
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Sayko:

üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}
üí¨ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {total_messages}
üìÖ –î–∞—Ç–∞: {datetime.now().strftime("%Y-%m-%d")}

üöÄ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Render.com
"""
    bot.reply_to(message, stats_text)

# –†–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
def solve_math_problem(text):
    try:
        text = text.lower().strip()
        
        # –£–±–∏—Ä–∞–µ–º "—Ä–µ—à–∏" –µ—Å–ª–∏ –µ—Å—Ç—å
        if text.startswith('—Ä–µ—à–∏'):
            text = text[4:].strip()
        
        # –ü—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
        if all(c in '0123456789+-*/.() ' for c in text.replace(' ', '')):
            expr = text.replace(' ', '').replace('^', '**')
            result = eval(expr)
            return f"üßÆ {text} = {result}"
        
        # –£—Ä–∞–≤–Ω–µ–Ω–∏—è —Å x
        if '=' in text and 'x' in text:
            # –û—á–∏—â–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
            eq = text.replace(' ', '').replace('^', '**')
            
            if '=' in eq:
                left, right = eq.split('=')
                x = sp.symbols('x')
                
                # –°–æ–∑–¥–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
                equation = sp.Eq(sp.sympify(left), sp.sympify(right))
                solution = sp.solve(equation, x)
                
                if solution:
                    return f"üìê –£—Ä–∞–≤–Ω–µ–Ω–∏–µ: {text}\n\nüìä –†–µ—à–µ–Ω–∏–µ: x = {solution}"
        
        return None
        
    except Exception as e:
        print(f"Math error: {e}")
        return None

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    user_id = message.from_user.id
    text = message.text.strip()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if user_id not in user_stats:
        user_stats[user_id] = {
            'name': message.from_user.first_name,
            'messages': 0,
            'last_active': datetime.now()
        }
    user_stats[user_id]['messages'] += 1
    user_stats[user_id]['last_active'] = datetime.now()
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
    if text.startswith('/'):
        return
    
    # –ü—Ä–æ–±—É–µ–º —Ä–µ—à–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
    math_result = solve_math_problem(text)
    if math_result:
        bot.reply_to(message, math_result)
        return
    
    # –ò—â–µ–º –≤ Wikipedia
    try:
        search_results = wikipedia.search(text)
        if search_results:
            summary = wikipedia.summary(search_results[0], sentences=2)
            bot.reply_to(message, f"üìö {summary}")
            return
    except:
        pass
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ
    bot.reply_to(message, 
        "ü§î –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:\n"
        "‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π (2+3, x+5=10)\n"
        "‚Ä¢ –£—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏ (—Ä–µ—à–∏ x^2-4=0)\n"
        "‚Ä¢ –û–±—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä!")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    print("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üìû –ò—â–∏—Ç–µ: @SaykoStudyBot –≤ Telegram")
    bot.polling(none_stop=True)
